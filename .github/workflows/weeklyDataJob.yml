name: Weekly Data Job

on:
  schedule:
    - cron: "15 11 * * SAT" # every Saturday at 11:15 UTC
  workflow_dispatch: # allows manual trigger

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repo
      - uses: actions/checkout@v3

      # Step 2: Setup Node
      - uses: actions/setup-node@v3
        with:
          node-version: 20

      # Step 3: Authenticate with GCP
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: klett-cx-analytics

      # Step 4: Run main script (generates timestamped JSON in data/)
      - name: Run clean-fetch-districts.cjs
        run: node scripts/clean-fetch-districts.cjs

      # Step 5: Flatten the latest JSON file
      - name: Flatten latest JSON
        run: |
          DATA_DIR="./data"
          latest_file=$(ls -t "$DATA_DIR"/LicenseData_*.json | head -n 1)
          echo "Flattening $latest_file"
          node scripts/flattenerJsonToCsv.cjs "$latest_file"

      # Step 6: Upload all JSON and flattened CSV files as artifacts
      - name: Upload License Data
        uses: actions/upload-artifact@v4
        with:
          name: license-data
          path: data/LicenseData_*.json,data/*_flattened.csv
